<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clearly's Mechabellum Voice Unit Counter Tool</title>
    <!-- Load Tailwind CSS from CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a2e;
            color: #e0e0e0;
        }
    </style>
</head>
<body class="flex flex-col items-center p-4">

    <!-- Main Container -->
    <div class="bg-gray-800 p-6 rounded-xl shadow-2xl max-w-2xl w-full relative">
        <!-- Version Number -->
        <span class="absolute top-4 right-4 text-xs text-gray-400">v1.6</span>
        
        <h1 class="text-3xl font-bold text-center mb-4 text-sky-400">Clearly's Mechabellum Voice Unit Counter Tool</h1>

        <!-- Aerial Advantage Warning Banner (Initially Hidden) -->
        <div id="aerial-warning" class="hidden bg-yellow-500 text-yellow-900 font-bold p-2 rounded-lg text-center shadow-md mb-4 transition-all duration-300">
            Warning: <span id="advantage-side"></span> has an aerial advantage!
        </div>

        <!-- Control Buttons and Status/Command Display -->
        <div class="flex flex-col md:flex-row items-center justify-center gap-2 mb-4">
            <button id="toggle-voice-btn" class="p-0.5 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg shadow-md transition duration-300 w-full md:w-auto">
                Start Listening
            </button>
            <!-- Single combined element for status and last command, now on the same line -->
            <p id="status-message" class="text-gray-400 italic text-center mt-2 md:mt-0">Press the button to begin.</p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Friendly Units Display - Now with green background -->
            <div class="bg-green-700 p-4 rounded-lg shadow-inner flex flex-col text-white">
                <h2 id="friendly-units-title" class="text-xl font-semibold mb-2 text-center">Friendly Units: 0</h2>
                <ul id="friendly-units-list" class="list-disc pl-5 space-y-1 flex-grow text-sm">
                    <li class="text-white">Add friendly units via voice.</li>
                </ul>
            </div>
            
            <!-- Enemy Units Display - Now with red background -->
            <div class="bg-red-700 p-4 rounded-lg shadow-inner flex flex-col text-white">
                <h2 id="enemy-units-title" class="text-xl font-semibold mb-2 text-center">Enemy Units: 0</h2>
                <ul id="enemy-units-list" class="list-disc pl-5 space-y-1 flex-grow text-sm">
                    <li class="text-white">Add enemy units via voice.</li>
                </ul>
            </div>
        </div>

        <!-- Counters Display -->
        <div class="bg-gray-700 p-4 rounded-lg shadow-inner mt-4">
            <h2 class="text-xl font-semibold text-white mb-2">Counter Recommendations</h2>
            <ul id="recommendations-list" class="list-disc pl-5 space-y-2 text-sm">
                <li class="text-gray-400">Add enemy units to see counters.</li>
            </ul>
        </div>

        <!-- Footer -->
        <div class="mt-8 text-center text-gray-400 text-xs">
            <p>Code available on <a href="https://github.com/dsp6855/Clearly-s-Mechabellum-Voice-Unit-Counter-Tool/tree/main" class="text-indigo-400 hover:underline">GitHub</a></p>
            <p>&copy; 2025 Clearly Misunderstood</p>
        </div>
    </div>

    <script>
        // Use an IIFE (Immediately Invoked Function Expression) to avoid global pollution.
        (function() {
		// Check for Web Speech API support
			if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
				// Hide the button and show an error message
				document.getElementById('toggle-voice-btn').style.display = 'none';
				document.getElementById('status-message').textContent = 'Sorry, voice recognition is not supported in this browser.  Try Chrome.';
				document.getElementById('status-message').style.color = '#ffcc00';
				console.error('Web Speech API not supported in this browser.');
				return; // Stop the script from running further
			}
		
            // --- DATA ---
            // A mock mechData object with a "unitCount" and "cost" property.
            const mechData = {
                "Abyss": { "category": ["titan", "air", "ranged", "splash"], "descriptions": "Titan, air, late game, single unit, 100 range, splash, targets air and ground, upkeep cost", "unitCount": 1, "isAirUnit": true, "targets": ["air", "ground"], "cost": 200 },
                "Arclight": { "category": ["medium", "ground", "ranged", "splash"], "descriptions": "Medium, ground, anti-swarm, can do anti-air, single unit, splash, 93 range", "unitCount": 1, "isAirUnit": false, "targets": ["ground"], "cost": 100 },
                "Crawler": { "category": ["light", "ground", "melee"], "descriptions": "light, melee, ground, attacks ground only, 24 units, high speed", "unitCount": 24, "isAirUnit": false, "targets": ["ground"], "cost": 100 },
                "Fang": { "category": ["light", "ground", "ranged"], "descriptions": "light, ground, all-purpose, 18 units, 75 range, targets air and ground, can hide, high speed", "unitCount": 18, "isAirUnit": false, "targets": ["air", "ground"], "cost": 100 },
                "Farseer": { "category": ["large", "ground", "ranged", "splash"], "descriptions": "large, high speed, splash, 125 range, attack air and ground, single unit, rocket", "unitCount": 1, "isAirUnit": false, "targets": ["air", "ground"], "cost": 300 },
                "Fire Badger": { "category": ["medium", "ground", "ranged", "splash"], "descriptions": "medium, anti-swarm tank, splash, 60 range, targets ground only, 3 units", "unitCount": 3, "isAirUnit": false, "targets": ["ground"], "cost": 150 },
                "Fortress": { "category": ["giant", "ground", "ranged", "splash"], "descriptions": "giant, high damage, rocket, ground only target, 100 range, splash, slow, high hp, single unit", "unitCount": 1, "isAirUnit": false, "targets": ["ground"], "cost": 200 },
                "Hacker": { "category": ["medium", "ground", "special", "ranged"], "descriptions": "hacker, ground, disables tech, 110 range, high speed", "unitCount": 1, "isAirUnit": false, "targets": ["ground"], "cost": 200 },
                "Hounds": { "category": ["light", "ground", "ranged", "splash"], "descriptions": "high-speed, anti-unit, ground only, 70 range, 5 units", "unitCount": 5, "isAirUnit": false, "targets": ["ground"], "cost": 100 },
                "Marksman": { "category": ["light", "ground", "ranged"], "descriptions": "light, anti-air, targets air and ground, 140 range, single unit", "unitCount": 1, "isAirUnit": false, "targets": ["air", "ground"], "cost": 100 },
                "Melting Point": { "category": ["giant", "ground", "ranged", "splash"], "descriptions": "heavy, ground, anti-armor, flame, 115 range, large splash, single unit", "unitCount": 1, "isAirUnit": false, "targets": ["air", "ground"], "cost": 200 },
                "Mountain": { "category": ["titan", "ground", "ranged", "splash"], "descriptions": "giant, high hp, slow, ranged, 100 range, target ground only, 1 units", "unitCount": 1, "isAirUnit": false, "targets": ["ground"], "cost": 200 },
                "Mustang": { "category": ["light", "ground", "ranged"], "descriptions": "light, mobile, anti-air, targets air and ground, 95 range, 12 units", "unitCount": 12, "isAirUnit": false, "targets": ["air", "ground"], "cost": 200 },
                "Overlord": { "category": ["giant", "air", "ranged", "splash"], "descriptions": "giant, anti-swarm, fire, 120 range, splash, single unit, high hp, fast", "unitCount": 1, "isAirUnit": true, "targets": ["air", "ground"], "cost": 200 },
                "Phantom Ray": { "category": ["medium", "air", "ranged", "splash"], "descriptions": "light, air, 65 range, high speed, single unit, splash, targets air and ground, low hp", "unitCount": 3, "isAirUnit": true, "targets": ["air", "ground"], "cost": 200 },
                "Phoenix": { "category": ["medium", "air", "ranged", "splash"], "descriptions": "medium, air, 120 range, targets air and ground, 2 units, splash, high speed", "unitCount": 2, "isAirUnit": true, "targets": ["air", "ground"], "cost": 200 },
                "Raiden": { "category": ["giant", "air", "ranged"], "descriptions": "heavy, ground, 110 range, single unit, targets air and ground, rocket", "unitCount": 1, "isAirUnit": true, "targets": ["air", "ground"], "cost": 200 },
                "Rhino": { "category": ["heavy", "ground", "melee", "splash"], "descriptions": "heavy, high hp, ground, anti-armor, single unit, splash", "unitCount": 1, "isAirUnit": false, "targets": ["ground"], "cost": 200 },
                "Sabertooth": { "category": ["heavy", "ground", "ranged"], "descriptions": "heavy, 90 range, single unit", "unitCount": 1, "isAirUnit": false, "targets": ["ground"], "cost": 150 },
                "Sandworm": { "category": ["giant", "ground", "ranged", "splash"], "descriptions": "giant, ground, splash, single unit, burrow. Can attack air with tech upgrade.", "unitCount": 1, "isAirUnit": false, "targets": ["ground"], "cost": 200 },
                "Scorpion": { "category": ["heavy", "ground", "ranged", "splash"], "descriptions": "heavy, anti-swarm, big splsh, high damage, slow speed, target ground only, single unit, 100 range", "unitCount": 1, "isAirUnit": false, "targets": ["ground"], "cost": 300 },
                "Sledgehammer": { "category": ["heavy", "ground", "ranged", "splash"], "descriptions": "Heavy Tank, ranged, ground target, splash, slow, 95 range, 5 units", "unitCount": 5, "isAirUnit": false, "targets": ["ground"], "cost": 200 },
                "Steel Ball": { "category": ["medium", "ground", "ranged"], "descriptions": "high-speed, anti-unit, ground only 45 range, attack grows longer attacking, 4 units", "unitCount": 4, "isAirUnit": false, "targets": ["ground"], "cost": 200 },
                "Stormcaller": { "category": ["heavy", "ground", "ranged", "splash"], "descriptions": "heavy rocket launcher, target ground only, splash, 180 range, 4 units, rockets", "unitCount": 4, "isAirUnit": false, "targets": ["ground"], "cost": 200 },
                "Tarantula": { "category": ["heavy", "ground", "ranged", "splash"], "descriptions": "heavy, splash, 80 range, fast attack, single unit", "unitCount": 1, "isAirUnit": false, "targets": ["ground"], "cost": 200 },
                "Typhoon": { "category": ["heavy", "ground", "ranged", "splash"], "descriptions": "heavy, all purpose, splash, quick attack, 100 range, targets air and ground, 2 units", "unitCount": 2, "isAirUnit": false, "targets": ["air", "ground"], "cost": 150 },
                "Void Eye": { "category": ["light", "ground", "special", "ranged"], "descriptions": "light, high damage, 100 range, target ground only, 3 units. Can attack air with tech upgrade.", "unitCount": 3, "isAirUnit": false, "targets": ["ground"], "cost": 100 },
                "Vulcan": { "category": ["giant", "ground", "ranged", "splash"], "descriptions": "giant, anti-swarm, fire, large spash, 95 range,target ground only, single unit, high hp", "unitCount": 1, "isAirUnit": false, "targets": ["ground"], "cost": 200 },
                "War Factory": { "category": ["titan", "ground", "ranged", "splash"], "descriptions": "titan, produces other units, high hp, expensive, 100 range, targets ground only, splash, slow, upkeep cost", "unitCount": 1, "isAirUnit": false, "targets": ["ground"], "cost": 200 },
                "Wasp": { "category": ["light", "air", "ranged"], "descriptions": "light, air, 12 units, 50 range, high speed, targets air and ground, low HP", "unitCount": 12, "isAirUnit": true, "targets": ["air", "ground"], "cost": 200 },
                "Wrath": { "category": ["heavy", "air", "ranged", "splash"], "descriptions": "heavy, air, single unit, 60 range, splash", "unitCount": 1, "isAirUnit": true, "targets": ["air", "ground"], "cost": 300 }
            };
            
            // This is the correct counters data, replacing the previous duplicate.
            const countersData = {
                "Abyss": { "weakness": ["Marksman", "Mustang", "Wasp", "Melting Point"], "resistance": [] },
                "Arclight": { "weakness": ["Stormcaller", "Steel Ball","Rhino", "Scorpion", "Vulcan", "Overlord", "Melting Point", "Fortress", "War Factory"], "resistance": ["Crawler", "Hounds", "Steel Ball", "Fang", "Mustang"] },
                "Crawler": { "weakness": ["Arclight","Fire Badger", "Vulcan", "Sledgehammer", "Rhino", "Wrath"], "resistance": ["Fang", "Marksman", "Sabertooth", "Steel Ball", "Melting Point", "Hacker"] },
                "Fang": { "weakness": ["Fire Badger", "Typhoon", "Mustang", "Steel Ball", "Wrath", "Rhino","Vulcan"], "resistance": ["Marksman", "Wasp", "Phoenix", "Overlord"] },
                "Farseer": { "weakness": ["Rhino", "Melting Point", "Fortress", "War Factory"], "resistance": ["Marksman", "Hacker", "Phoenix", "Wrath"] },
                "Fire Badger": { "weakness": ["Rhino", "Fortress", "War Factory", "Sabertooth", "Overlord"], "resistance": ["Crawler", "Fang", "Arclight", "Mustang"] },
                "Fortress": { "weakness": ["Fang", "Steel Ball", "Overlord", "Melting Point"], "resistance": ["Sledgehammer", "Tarantula", "Vulcan", "Fire Badger", "Typhoon"] },
                "Hacker": { "weakness": ["Fang", "Stormcaller", "War Factory", "Phoenix", "Crawler", "Overlord"], "resistance": ["Fire Badger", "Arclight", "Scorpion", "Sledgehammer", "Steel Ball"] },
                "Hounds": { "weakness": ["Fire Badger", "Vulcan", "Overlord", "Arclight", "Melting Point", "Scorpion", "Sledgehammer", "Steel Ball", "Rhino"], "resistance": ["Fang", "Mustang", "Wasp", "Phantom Ray", "Phoenix", "Farseer", "Raiden", "Wrath", "Hacker"] },
                "Marksman": { "weakness": ["Crawler", "Fang", "Mustang", "War Factory", "Farseer"], "resistance": ["Arclight", "Hacker","Overlord", "Phoenix", "Wrath"] },
                "Melting Point": { "weakness": ["Crawler", "Marksman", "Phoenix","Steel Ball"], "resistance": ["Scorpion", "Fortress", "Rhino", "Vulcan", "Typhoon"] },
                "Mountain": { "weakness": ["Rhino", "Sledgehammer", "Scorpion", "Vulcan", "Overlord", "Melting Point", "Sandworm", "Stormcaller", "Tarantula"], "resistance": ["Crawler", "Hounds", "Sabertooth", "Steel Ball", "Void Eye"] },
                "Mustang": { "weakness": ["Fang","Rhino", "Wasp","Phoenix","Overlord","Farseer", "Tarantula"], "resistance": ["Vulcan", "Sledgehammer", "War Factory", "Typhoon", "Fire Badger"] },
                "Overlord": { "weakness": ["Melting Point", "Phoenix", "Wasp", "Mustang"], "resistance": ["Rhino", "Steel Ball", "Sledgehammer", "Stormcaller", "Vulcan", "Arclight", "Hacker", "Scorpion", "Fire Badger", "Sabertooth", "Typhoon"] },
                "Phantom Ray": { "weakness": ["Marksman", "Mustang", "Wasp", "Typhoon", "Phoenix", "Farseer", "Raiden", "Wrath"], "resistance": ["Arclight", "Fire Badger", "Fortress", "Melting Point", "Rhino", "Sabertooth", "Sandworm", "Scorpion", "Sledgehammer", "Steel Ball", "Stormcaller", "Tarantula", "Typhoon", "Vulcan", "War Factory"] },
                "Phoenix": { "weakness": ["Mustang", "Fang", "Wasp", "Marksman", "Farseer"], "resistance": ["Overlord", "Stormcaller", "Vulcan", "Typhoon", "Sabertooth", "Fire Badger"] },
                "Raiden": { "weakness": ["Farseer", "Marksman", "Melting Point", "Overlord", "Phoenix"], "resistance": ["Fire Badger", "Sledgehammer", "Steel Ball", "Stormcaller"] },
                "Rhino": { "weakness": ["Steel Ball", "War Factory", "Phoenix", "Melting Point", "Hacker", "Overlord"], "resistance": ["Fire Badger", "Crawler", "Mustang", "Vulcan", "Stormcaller", "Marksman"] },
                "Sabertooth": { "weakness": ["Crawler", "Fang", "Steel Ball", "Melting Point", "Fortress", "War Factory"], "resistance": ["Sledgehammer", "Tarantula", "Hacker", "Vulcan", "Typhoon", "Fire Badger", "Farseer"] },
                "Sandworm": { "weakness": ["Sledgehammer", "Stormcaller", "Tarantula", "Rhino"], "resistance": ["Crawler", "Hacker", "Hounds", "Marksman", "Melting Point", "Sabertooth", "Steel Ball", "Void Eye"] },
                "Scorpion": { "weakness": ["Wasp", "Overlord", "Phoenix"], "resistance": ["Sledgehammer", "Tarantula", "Hacker", "Vulcan", "Fire Badger", "Typhoon", "War Factory"] },
                "Sledgehammer": { "weakness": ["Phoenix", "Vulcan", "War Factory"], "resistance": ["Crawler", "Mustang", "Arclight"] },
                "Steel Ball": { "weakness": ["Crawler", "Phoenix", "Overlord"], "resistance": ["Sledgehammer", "Tarantula", "Rhino", "Sandworm"] },
                "Stormcaller": { "weakness": ["Marksman", "Arclight", "Mustang", "Vulcan", "Fortress", "Typhoon", "Fang", "Overlord"], "resistance": ["Rhino", "Sledgehammer", "War Factory"] },
                "Tarantula": { "weakness": ["Steel Ball", "War Factory", "Stormcaller", "Fortress", "Marksman", "Melting Point", "Overlord", "Phoenix"], "resistance": ["Arclight", "Mustang", "Hacker"] },
                "Typhoon": { "weakness": ["War Factory", "Steel Ball", "Scorpion", "Melting Point", "Phoenix", "Sabertooth"], "resistance": ["Mustang", "Wasp", "Crawler", "Fang", "Hounds"] },
                "Void Eye": { "weakness": ["Crawler", "Melting Point", "Rhino", "Scorpion", "Sledgehammer", "Steel Ball", "Tarantula", "Typhoon", "Vulcan"], "resistance": ["Hacker", "Hounds", "Marksman", "Sabertooth", "Stormcaller"] },
                "Vulcan": { "weakness": ["Fortress", "Melting Point", "Overlord", "Phoenix", "Steel Ball"], "resistance": ["Crawler", "Arclight", "Marksman", "Mustang", "Sledgehammer"] },
                "War Factory": { "weakness": ["Melting Point", "Scorpion", "Overlord"], "resistance": ["Arclight", "Stormcaller", "Sledgehammer", "Steel Ball", "Rhino", "Sabertooth", "Vulcan", "Typhoon"] },
                "Wasp": { "weakness": ["Mustang", "Fang", "Wrath"], "resistance": ["Marksman", "Phoenix", "Melting Point", "Overlord"] },
                "Wrath": { "weakness": ["Fortress", "Tarantula", "Marksman", "Wasp"], "resistance": ["Crawler", "Mustang", "Arclight", "Sledgehammer", "Steel Ball", "Rhino"] }
            };
            
            // This loop adds each unit to its own weakness array for complete counter logic.
            for (const unit in countersData) {
                if (countersData.hasOwnProperty(unit)) {
                    if (!countersData[unit].weakness.includes(unit)) {
                        countersData[unit].weakness.push(unit);
                    }
                }
            }
            
            // Map for converting spoken numbers to integers
            const numberWords = {
                'one': 1, 'an':1, 'a':1, 'two': 2, 'to':2, 'three': 3, 'through':3, 'four': 4, 'for':4, 'five': 5,
                'six': 6, 'seven': 7, 'eight': 8, 'nine': 9, 'ten': 10
            };
            
            // Map for handling common voice recognition misrecognitions or alternate names
            const nameMap = {
				'of this': 'Abyss',
                'arc light': 'Arclight',
                'arclights': 'Arclight',
                'arc lights': 'Arclight',
                'fire badgers': 'Fire Badger',
                'wasps': 'Wasp',
                'crawlers': 'Crawler',
                'crawler': 'Crawler',
                'hounds': 'Hounds',
                'hound': 'Hounds',
                'hand': 'Hounds',
                'fangs': 'Fang',
                'things': 'Fang',
                'marksmen': 'Marksman', // Added for irregular plural
                'marskmans': 'Marksman', // Added for common typo
                'mustangs': 'Mustang',
                'steel balls': 'Steel Ball',
                'steel ball': 'Steel Ball',
                'still balls': 'Steel Ball',
                'typhoons': 'Typhoon',
                'void eyes': 'Void Eye',
                'void eye': 'Void Eye',
                'void I': 'Void Eye',
                'void i': 'Void Eye',
                'sledgehammers': 'Sledgehammer',
                'stormcallers': 'Stormcaller',
                'storm collars': 'Stormcaller',
                'storm coller': 'Stormcaller',
                'storm collars': 'Stormcaller',
                'storm collar': 'Stormcaller',
                'phantom rays': 'Phantom Ray',
                'phantom ray': 'Phantom Ray',
                'phoenixes': 'Phoenix',
                'rhinos': 'Rhino',
                'sabertooths': 'Sabertooth',
                'saber tooth': 'Sabertooth',
                'saber tooths': 'Sabertooth',
                'scorpions': 'Scorpion',
                'tarantulas': 'Tarantula',
                'abysses': 'Abyss',
                'farseers': 'Farseer',
                'farce here': 'Farseer',
                'Farsiers': 'Farseer',
                'Farsier': 'Farseer',
                'five Sears': 'Farseer',
                'farts here': 'Farseer',
                'fars here': 'Farseer',
                'fortresses': 'Fortress',
                'hackers': 'Hacker',
                'melting points': 'Melting Point', 
                'melting point': 'Melting Point', 
                'melting': 'Melting Point', 
                'mountains': 'Mountain',
                'overlords': 'Overlord',
                'raidens': 'Raiden',
                'sandworms': 'Sandworm',
                'sand worms': 'Sandworm',
                'sand worm': 'Sandworm',
                'vulcans': 'Vulcan',
                'war factories': 'War Factory',
                'War Factory': 'War Factory',
                'work Factory': 'War Factory',
                'more Factory': 'War Factory',
                'more factories': 'War Factory',
                'wraths': 'Wrath',
				'testTry': 'testTry'
            };

            let friendlyUnits = {}; // This object stores friendly units and their counts.
            let enemyUnits = {}; // This object stores enemy units and their counts.
            let recognition;
            let isListening = false;

            // --- DOM ELEMENTS ---
            const toggleButton = document.getElementById('toggle-voice-btn');
            const statusMessage = document.getElementById('status-message');
            const friendlyUnitsList = document.getElementById('friendly-units-list');
            const enemyUnitsList = document.getElementById('enemy-units-list');
            const friendlyUnitsTitle = document.getElementById('friendly-units-title');
            const enemyUnitsTitle = document.getElementById('enemy-units-title');
            const recommendationsList = document.getElementById('recommendations-list');
            const aerialWarning = document.getElementById('aerial-warning');
            const advantageSideSpan = document.getElementById('advantage-side');

            // --- FUNCTIONS ---
            /**
             * Updates the displayed lists of friendly and enemy units.
             */
            const updateUnitsDisplay = () => {
                // Clear existing lists
                friendlyUnitsList.innerHTML = '';
                enemyUnitsList.innerHTML = '';

                // Populate friendly units list
                const friendlyUnitNames = Object.keys(friendlyUnits);
                if (friendlyUnitNames.length === 0) {
                    friendlyUnitsList.innerHTML = '<li class="text-white">Add friendly units via voice.</li>';
                } else {
                    friendlyUnitNames.forEach(unit => {
                        const li = document.createElement('li');
                        li.textContent = `${unit.charAt(0).toUpperCase() + unit.slice(1)} x${friendlyUnits[unit]}`;
                        friendlyUnitsList.appendChild(li);
                    });
                }
                
                // Populate enemy units list
                const enemyUnitNames = Object.keys(enemyUnits);
                if (enemyUnitNames.length === 0) {
                    enemyUnitsList.innerHTML = '<li class="text-white">Add enemy units via voice.</li>';
                } else {
                    enemyUnitNames.forEach(unit => {
                        const li = document.createElement('li');
                        li.textContent = `${unit.charAt(0).toUpperCase() + unit.slice(1)} x${enemyUnits[unit]}`;
                        enemyUnitsList.appendChild(li);
                    });
                }
            };
            
            /**
             * Calculates and updates the counter totals.
             */
            const updateCounterCalculations = () => {
                let friendlyUnitGroupsTotal = 0;
                let enemyUnitGroupsTotal = 0;

                // Calculate total counter value for friendly units (count of groups)
                Object.keys(friendlyUnits).forEach(unitName => {
                    const quantity = friendlyUnits[unitName];
                    friendlyUnitGroupsTotal += quantity;
                });
                
                // Calculate total enemy units for display (count of groups)
                Object.keys(enemyUnits).forEach(unitName => {
                    enemyUnitGroupsTotal += enemyUnits[unitName];
                });

                // Update the UI with the totals
                friendlyUnitsTitle.textContent = `Friendly Units: ${friendlyUnitGroupsTotal}`;
                enemyUnitsTitle.textContent = `Enemy Units: ${enemyUnitGroupsTotal}`;
            };
            
            /**
             * Renders a list of counter recommendations based on the enemy units, sorted by effectiveness and cost.
             */
            const renderRecommendations = () => {
                recommendationsList.innerHTML = ''; // Clear the list
                
                const enemyUnitNames = Object.keys(enemyUnits);

                if (enemyUnitNames.length === 0) {
                    recommendationsList.innerHTML = '<li class="text-gray-400">Add enemy units to see counters.</li>';
                    return;
                }

                enemyUnitNames.forEach(enemyUnitName => {
                    const weaknesses = countersData[enemyUnitName]?.weakness || [];
                    const isCountered = weaknesses.some(counter => friendlyUnits[counter] > 0);
                    
                    const li = document.createElement('li');
                    li.classList.add('p-2', 'rounded-md', 'mb-2', 'shadow-sm', 'border');

                    let statusText = '';
                    let statusClass = '';
                    if (isCountered) {
                        statusText = 'Countered! ✅';
                        statusClass = 'bg-green-700 border-green-500';
						// Find the friendly units that are countering this enemy unit
						const counteringUnits = weaknesses.filter(counter => friendlyUnits[counter] > 0);

						// Build the message string
						const counteringMessage = counteringUnits.map(unitName => {
							const quantity = friendlyUnits[unitName];
							return `${quantity} ${unitName.charAt(0).toUpperCase() + unitName.slice(1)}`
						}).join(', ');

						// Add a new paragraph or span to your list item to show the counters
						const counterInfo = document.createElement('p');
						counterInfo.classList.add('text-sm', 'text-gray-300', 'mt-1');
						counterInfo.textContent = `Countered by: ${counteringMessage}`;
						li.appendChild(counterInfo);
                    } else {
                        statusText = 'Needs Counters ❌';
                        statusClass = 'bg-red-700 border-red-500';
                    }

                    li.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-bold text-white">${enemyUnitName.charAt(0).toUpperCase() + enemyUnitName.slice(1)}</span>
                            <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${statusClass}">${statusText}</span>
                        </div>
                    `;

                    // Only show counter recommendations if the unit is not yet countered
                    if (!isCountered) {
                        const unownedCounters = weaknesses.filter(counter => !friendlyUnits[counter] || friendlyUnits[counter] === 0);
						// Sort the unownedCounters array by cost
						unownedCounters.sort((a, b) => {
							// Get the cost for unit 'a' and unit 'b'
							const costA = mechData[a]?.cost || Infinity; // Use Infinity if cost is missing
							const costB = mechData[b]?.cost || Infinity;
							return costA - costB; // This sorts in ascending order (lowest cost first)
						});
                        if (unownedCounters.length > 0) {
                            const counterList = document.createElement('ul');
                            counterList.classList.add('list-disc', 'list-inside', 'text-gray-300', 'ml-4', 'mt-1');
                            unownedCounters.forEach(counter => {
                                const counterLi = document.createElement('li');
                                const cost = mechData[counter]?.cost || 'N/A';
                                counterLi.innerHTML = `${counter} (Cost: ${cost})`;
                                counterList.appendChild(counterLi);
                            });
                            li.appendChild(counterList);
                        } else {
                            const counterLi = document.createElement('li');
                            counterLi.classList.add('text-gray-400', 'ml-4', 'italic', 'mt-1');
                            counterLi.textContent = "No recommended counters found.";
                            li.appendChild(counterLi);
                        }
                    }

                    recommendationsList.appendChild(li);
                });
            };

            /**
             * Checks for an aerial advantage and displays a warning banner.
             */
            const checkAerialAdvantage = () => {
                let friendlyAirUnits = false;
                let friendlyAntiAirUnits = false;
                let enemyAirUnits = false;
                let enemyAntiAirUnits = false;

                // Check friendly units for air and anti-air capability
                for (const unit in friendlyUnits) {
                    if (mechData[unit]?.isAirUnit) {
                        friendlyAirUnits = true;
                    }
                    if (mechData[unit]?.targets.includes("air")) {
                        friendlyAntiAirUnits = true;
                    }
                }

                // Check enemy units for air and anti-air capability
                for (const unit in enemyUnits) {
                    if (mechData[unit]?.isAirUnit) {
                        enemyAirUnits = true;
                    }
                    if (mechData[unit]?.targets.includes("air")) {
                        enemyAntiAirUnits = true;
                    }
                }
                
                // Determine and display the warning banner
                if (friendlyAirUnits && !enemyAntiAirUnits) {
                    advantageSideSpan.textContent = 'Friendly Side';
                    aerialWarning.classList.remove('hidden');
                } else if (enemyAirUnits && !friendlyAntiAirUnits) {
                    advantageSideSpan.textContent = 'Enemy Side';
                    aerialWarning.classList.remove('hidden');
                } else {
                    aerialWarning.classList.add('hidden');
                }
            };


            /**
             * Processes a recognized voice command to add or remove a unit.
             */
            const processCommand = (command) => {
                // Convert the entire command to lowercase to handle case variations.
                const commandLower = command.toLowerCase();
                const commandWords = commandLower.split(' ');
                let action = '';
                let unitType = '';
                let unitName = '';
                let quantity = 1;

                // Handle the reset command first as a special case
                if (commandLower.trim() === 'reset counters') {
                    friendlyUnits = {};
                    enemyUnits = {};
                    updateUnitsDisplay();
                    updateCounterCalculations();
                    renderRecommendations();
                    checkAerialAdvantage();
                    statusMessage.textContent = 'Counters have been reset.';
                    console.log('Counters have been reset.');
                    return;
                }
                
                // Check for action (add, remove)
                action = commandWords[0];
                if (action === 'ad') action = 'add'; // Handle common misrecognition
                if (action === 'bad') action = 'add'; // Handle common misrecognition
                if (action === 'had') action = 'add'; // Handle common misrecognition
                if (action === 'i had') action = 'add'; // Handle common misrecognition

                // Find the quantity and unit type
                let wordsAfterAction = commandWords.slice(1);
                
                // Look for a number word or digit
                const numberIndex = wordsAfterAction.findIndex(word => !isNaN(parseInt(word)) || numberWords[word]);
                if (numberIndex !== -1) {
                    const numberWord = wordsAfterAction[numberIndex];
                    quantity = parseInt(numberWord) || numberWords[numberWord];
                    // Remove the number from the array
                    wordsAfterAction.splice(numberIndex, 1);
                }
				// Check if the first word is "a" or "an" and remove it
				if (wordsAfterAction.length > 0 && (wordsAfterAction[0] === 'a' || wordsAfterAction[0] === 'an')) {
					wordsAfterAction.splice(0, 1);
				}

                // Look for unit type (friendly, enemy)
                const unitTypeIndex = wordsAfterAction.findIndex(word => word === 'friendly' || word === 'enemy');
                if (unitTypeIndex !== -1) {
                    unitType = wordsAfterAction[unitTypeIndex];
                    // Remove the unit type from the array
                    wordsAfterAction.splice(unitTypeIndex, 1);
                } else {
                    // Default to enemy if not specified
                    unitType = 'enemy';
                }

                // The remaining words should form the unit name
                unitName = wordsAfterAction.join(' ');
                
                // Update the last command display
                statusMessage.textContent = `Command: "${command}"`;

                // Normalize the unit name to match the case in the data.
                // First, check the name map for common phrases
                const mappedName = nameMap[unitName];
                if (mappedName) {
                    unitName = mappedName;
                } else {
                    // If no map entry, handle simple pluralization by removing 's'
                    const singularName = unitName.replace(/s$/, '');
                    // Then, normalize the name for lookup
                    unitName = singularName.charAt(0).toUpperCase() + singularName.slice(1);
                }
                
                if (mechData[unitName]) {
                    if (action === 'add') {
                        if (unitType === 'friendly') {
                            friendlyUnits[unitName] = (friendlyUnits[unitName] || 0) + quantity;
                            console.log(`Added ${quantity} friendly units: ${unitName}`);
                        } else if (unitType === 'enemy') {
                            enemyUnits[unitName] = (enemyUnits[unitName] || 0) + quantity;
                            console.log(`Added ${quantity} enemy units: ${unitName}`);
                        }
                    } else if (action === 'remove') {
                        if (unitType === 'friendly' && friendlyUnits[unitName]) {
                            friendlyUnits[unitName] -= quantity;
                            if (friendlyUnits[unitName] <= 0) {
                                delete friendlyUnits[unitName];
                            }
                            console.log(`Removed ${quantity} friendly units: ${unitName}`);
                        } else if (unitType === 'enemy' && enemyUnits[unitName]) {
                            enemyUnits[unitName] -= quantity;
                            if (enemyUnits[unitName] <= 0) {
                                delete enemyUnits[unitName];
                            }
                            console.log(`Removed ${quantity} enemy units: ${unitName}`);
                        }
                    } else {
                        console.log(`Unknown command: ${command}`);
                        statusMessage.textContent += ' (unknown command)';
                    }
                } else {
                    console.log(`Unknown unit: ${unitName}`);
                    statusMessage.textContent += ' (unknown unit)';
                }

                updateUnitsDisplay();
                updateCounterCalculations();
                renderRecommendations();
                checkAerialAdvantage(); // Call this new function after processing the command
            };

            /**
             * Initializes and starts the voice recognition service.
             */
            const startVoiceRecognition = () => {
                // Check for browser support
                if (!('webkitSpeechRecognition' in window)) {
                    statusMessage.textContent = 'Voice recognition is not supported in this browser.';
                    toggleButton.disabled = true;
                    return;
                }

                recognition = new webkitSpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = false;
                recognition.lang = 'en-US';

                // Event handler for when a command is recognized
                recognition.onresult = (event) => {
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        const transcript = event.results[i][0].transcript.trim().toLowerCase();
                        if (event.results[i].isFinal) {
                            processCommand(transcript);
                        }
                    }
                };

                // Event handler for errors
                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    statusMessage.textContent = 'Error: ' + event.error;
                    stopVoiceRecognition();
                };

                // Event handler for when listening stops
                recognition.onend = () => {
                    if (isListening) {
                        console.log('Restarting recognition...');
                        recognition.start();
                    } else {
                        statusMessage.textContent = 'Stopped.';
                        toggleButton.textContent = 'Start Listening';
                    }
                };

                recognition.start();
                isListening = true;
                statusMessage.textContent = 'Listening... Try "add three friendly crawlers" or "reset counters".';
                toggleButton.textContent = 'Stop Listening';
                console.log('Voice recognition started.');
            };

            /**
             * Stops the voice recognition service.
             */
            const stopVoiceRecognition = () => {
                if (recognition) {
                    isListening = false;
                    recognition.stop();
                    console.log('Voice recognition stopped.');
                }
            };
            
            // --- EVENT LISTENERS ---
            toggleButton.addEventListener('click', () => {
                if (isListening) {
                    stopVoiceRecognition();
                } else {
                    startVoiceRecognition();
                }
            });

            // Initial UI update
            updateUnitsDisplay();
            updateCounterCalculations();
            renderRecommendations();
            checkAerialAdvantage();
        })();
    </script>
</body>
</html>
